
# Передача данных по TCP

После того, как соединение между клиентом и сервером установлено с помощью трёхстороннего рукопожатия, начинается основная часть работы – передача данных. TCP протокол обеспечивает надёжную, последовательную и проверенную передачу данных между двумя узлами. В этом файле мы подробно разберём, как TCP осуществляет передачу данных, контролирует их целостность и корректность доставки.

## Основные принципы передачи данных в TCP

TCP, как надёжный протокол, гарантирует, что данные будут доставлены в правильной последовательности и без потерь. Для этого TCP использует механизм сегментации, подтверждения доставки и контроля потока.

### 1. Сегментация данных

Когда клиент или сервер хочет отправить большой объём данных, TCP разбивает его на небольшие блоки, называемые сегментами. Каждый сегмент содержит:
- **Порядковый номер** (Sequence Number) – он указывает позицию сегмента в общем потоке данных.
- **Номер подтверждения** (Acknowledgment Number) – этот номер используется для подтверждения получения предыдущих данных от получателя.

Пример: Клиент отправляет серверу файл размером 1000 байт. TCP может разделить его на сегменты по 100 байт каждый. Каждый сегмент будет иметь свой порядковый номер, что позволяет серверу собрать файл в правильной последовательности.

```
Сегмент 1: Seq=0, Data=100 байт
Сегмент 2: Seq=100, Data=100 байт
Сегмент 3: Seq=200, Data=100 байт
...
Сегмент 10: Seq=900, Data=100 байт
```

### 2. Подтверждение получения (ACK)

После получения каждого сегмента, сервер отправляет клиенту подтверждение (ACK). Это подтверждение содержит порядковый номер следующего ожидаемого сегмента. Например, если сервер получил сегмент с порядковым номером 100, он отправит клиенту ACK с номером 200, что означает готовность принять сегмент, начинающийся с 200-го байта.

Это позволяет TCP гарантировать доставку данных, даже если какой-либо сегмент был потерян в пути. Если клиент не получит подтверждение на отправленный сегмент в течение определённого времени, он отправит этот сегмент повторно.

### 3. Контроль потока

TCP использует механизм контроля потока, который предотвращает перегрузку сети или сервера. Каждый сегмент TCP содержит поле, называемое **окно** (window size). Это поле указывает, сколько данных получатель может принять в любой момент времени. Например, если размер окна равен 1000 байт, это означает, что сервер может принять до 1000 байт данных до того, как отправит новое подтверждение.

Если сервер перегружен или сеть становится медленной, размер окна уменьшается, чтобы избежать потери данных.

### 4. Повторная передача

TCP также предусматривает повторную передачу сегментов в случае потери данных. Если клиент не получает подтверждение для отправленного сегмента в течение определённого времени (тайм-аут), он считает, что сегмент был потерян, и отправляет его повторно. Это гарантирует, что все данные будут доставлены в полной мере, даже при наличии сбоев в сети.

### Пример передачи данных

Рассмотрим простой пример: клиент отправляет серверу файл через TCP. Файл состоит из 300 байт, которые разделены на три сегмента по 100 байт каждый.

1. Клиент отправляет первый сегмент:
    ```
    Клиент -> Сервер: Seq=0, Data=100 байт
    ```

2. Сервер получает сегмент и отправляет подтверждение:
    ```
    Сервер -> Клиент: ACK=100 (готов принять следующие данные)
    ```

3. Клиент отправляет второй сегмент:
    ```
    Клиент -> Сервер: Seq=100, Data=100 байт
    ```

4. Сервер снова подтверждает:
    ```
    Сервер -> Клиент: ACK=200
    ```

5. Клиент отправляет последний сегмент:
    ```
    Клиент -> Сервер: Seq=200, Data=100 байт
    ```

6. Сервер подтверждает получение всех данных:
    ```
    Сервер -> Клиент: ACK=300
    ```

### Контроль ошибок

TCP активно контролирует ошибки передачи данных:
- **Контрольные суммы**: Каждое сообщение TCP содержит контрольную сумму, которая позволяет получателю убедиться, что данные не были повреждены в процессе передачи. Если контрольная сумма не совпадает, сегмент отбрасывается.
- **Тайм-ауты**: Если отправитель не получает подтверждение (ACK) в течение определённого времени, он повторно отправляет сегмент. Тайм-ауты динамически адаптируются к условиям сети, чтобы минимизировать задержки и повторные передачи.

### Алгоритмы управления потоком и перегрузкой

TCP использует несколько алгоритмов для управления потоком данных и предотвращения перегрузок в сети:

1. **Алгоритм медленного старта**: Когда соединение только что установлено, TCP постепенно увеличивает скорость передачи данных, чтобы избежать перегрузки сети.

2. **Контроль перегрузки**: Если сеть становится перегруженной (например, из-за потери пакетов), TCP уменьшает скорость передачи данных и начинает постепенно увеличивать её по мере улучшения состояния сети.

3. **Окно скольжения**: TCP поддерживает динамическое окно передачи данных, которое адаптируется в зависимости от текущей пропускной способности сети и загруженности конечных точек.

### Заключение

Передача данных по TCP – это надёжный процесс, обеспечивающий целостность и корректную доставку данных между клиентом и сервером. TCP использует механизмы сегментации, подтверждения, контроля потока и исправления ошибок, чтобы обеспечить стабильную передачу даже в условиях нестабильной сети. Это делает TCP идеальным протоколом для приложений, требующих надёжности, таких как передача файлов, работа с базами данных или доступ к веб-страницам.
